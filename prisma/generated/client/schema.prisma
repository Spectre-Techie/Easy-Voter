// This is your Prisma schema file for EasyVoter
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  output     = "./generated/client"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

// User model - handles authentication for both voters and admins
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         Role     @default(VOTER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Password reset fields
  resetToken       String? // Token for password reset
  resetTokenExpiry DateTime? // Token expiration time

  // Relations
  application          VoterApplication?
  approvedApplications VoterApplication[] @relation("ApprovedBy")
  auditLogs            AuditLog[]
  // notifications Notification[] // DISABLED - feature removed

  @@index([email])
  @@index([resetToken])
}

enum Role {
  VOTER
  ADMIN
  SUPER_ADMIN
}

// Voter Application model - stores all registration data
model VoterApplication {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personal Information (Nigerian format)
  surname     String // Last name
  firstName   String
  middleName  String?
  dateOfBirth DateTime
  gender      Gender
  phoneNumber String // Nigerian format: +234...
  email       String
  occupation  String
  nin         String? // National Identity Number (11 digits)

  // Address Information (Nigerian-specific)
  state         String // 36 states + FCT
  lga           String // Local Government Area
  ward          String
  pollingUnit   String? // Auto-suggested based on address
  streetAddress String
  landmark      String? // For easy location

  // Document Upload
  idPhotoUrl        String // Valid ID (NIN Slip, Driver's License, Passport)
  idPhotoKey        String // Storage key for deletion/management
  passportPhotoUrl  String // Passport photograph
  passportPhotoKey  String
  proofOfAddressUrl String? // Optional: Utility bill, Tenancy agreement
  proofOfAddressKey String?

  // Additional Information
  disability        String? @default("None") // None, Visual, Hearing, Mobility, Other
  preferredLanguage String  @default("English") // English, Hausa, Yoruba, Igbo, Pidgin
  previousVoterCard String? // For transfers

  // Application Tracking
  applicationRef String            @unique // e.g., EV-2024-001234
  status         ApplicationStatus @default(DRAFT)
  submittedAt    DateTime?

  // Review Information
  reviewNotes         String?
  reviewedById        String?
  reviewedBy          User?     @relation("ApprovedBy", fields: [reviewedById], references: [id])
  reviewedAt          DateTime?
  reviewStartedAt     DateTime?
  estimatedCompletion DateTime?

  // Document Verification
  documentVerified  Boolean @default(false)
  verificationNotes String?

  // Voter Card Information
  voterCardId     String? @unique
  voterCardPdfUrl String?
  voterCardPdfKey String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([applicationRef])
  @@index([status])
  @@index([state, lga])
  @@index([createdAt])
  @@index([voterCardId])
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum ApplicationStatus {
  DRAFT // User started but hasn't submitted
  PENDING // Submitted, awaiting review
  UNDER_REVIEW // Being reviewed by admin
  APPROVED // Approved, voter card generated
  REJECTED // Rejected with reason
}

// Audit Log model - tracks all important actions for security
model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action     String // e.g., "APPROVED_APPLICATION", "REJECTED_APPLICATION"
  entityType String // e.g., "VoterApplication", "User"
  entityId   String
  metadata   Json? // Additional context as JSON
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityId])
  @@index([createdAt])
}

// Notification model - DISABLED (to avoid database reset)
// Uncomment when you're ready to add notifications feature
// model Notification {
//   id        String   @id @default(cuid())
//   userId    String
//   user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
//   
//   type      NotificationType
//   title     String
//   message   String
//   link      String?
//   
//   read      Boolean  @default(false)
//   createdAt DateTime @default(now())
//   
//   @@index([userId, read])
//   @@index([createdAt])
// }

// enum NotificationType {
//   APPLICATION_SUBMITTED
//   APPLICATION_APPROVED
//   APPLICATION_REJECTED
//   VOTER_CARD_READY
//   SYSTEM_UPDATE
//   SECURITY_ALERT
// }
